<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.46" />


<title>Machine Learning - Predictions with linear regressions - Michael Fuchs</title>
<meta property="og:title" content="Machine Learning - Predictions with linear regressions - Michael Fuchs">



  








<link href='//cdn.bootcss.com/highlight.js/9.11.0/styles/github.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/MFuchs.png"
         width="50"
         height="50"
         alt="MFuchs">
  </a>

  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="https://github.com/MFuchs1989/Bdown">GitHub</a></li>
    
    <li><a href="https://www.linkedin.com/in/michael-fuchs-139172131/">LinkedIn</a></li>
    
    <li><a href="https://twitter.com/Stat_Michael">Twitter</a></li>
    
    <li><a href="https://www.xing.com/profile/Michael_Fuchs426/cv?sc_o=mxb_p">XING</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">20 min read</span>
    

    <h1 class="article-title">Machine Learning - Predictions with linear regressions</h1>

    
    <span class="article-date">2019/01/11</span>
    

    <div class="article-content">
      <pre class="r"><code>library(tidyverse)
library(caret)
library(car)
library(glmnet)</code></pre>
<pre class="r"><code>machine &lt;- read_csv(&quot;machine.csv&quot;)
cars &lt;- read_csv(&quot;cars.csv&quot;)</code></pre>
<div id="table-of-content" class="section level1">
<h1>Table of Content</h1>
<ul>
<li>1 Introduction</li>
<li>2 Presentation of the data records used</li>
<li>3 Dividing the data into a training part and a test part</li>
<li>4 Removing problematic features</li>
<li>4.1 Machine dataset</li>
<li>4.2 Cars dataset</li>
<li>5 Assessing linear regression models</li>
<li>6 How to check some summary outputs individually</li>
<li>6.1 Residual analysis</li>
<li>6.2 Significance tests for linear regression</li>
<li>6.3 Residual standard error (RSE)</li>
<li>6.4 R<sup>2</sup></li>
<li>7 Test set performance with the MSE</li>
<li>8 Problems with linear regression</li>
<li>8.1 Multicollinearity</li>
<li>8.2 Outliers</li>
<li>8.2.1 Compare RSE</li>
<li>8.2.2 Compare MSE</li>
<li>9 Future selection</li>
<li>9.1 Forward selection</li>
<li>9.2 Backward selection</li>
<li>9.3 Comparing the calculated MSE</li>
<li>10 Regularization</li>
<li>11 Conclusion</li>
</ul>
</div>
<div id="introduction" class="section level1">
<h1>1 Introduction</h1>
<p>I have already written several general contributions on linear regression models (<a href="https://michael-fuchs.netlify.com/2018/09/21/regression-analysis/">“here”</a> and <a href="https://michael-fuchs.netlify.com/2018/10/02/special-regression-analysis/">“here”</a>). Likewise, I have already taken up the issue of how linear regression models can be trained and tested (<a href="https://michael-fuchs.netlify.com/2018/12/18/machine-learning-training-and-testing-sets-regression-modeling/">“Machine Learning - Training and Testing Sets: Regression Modeling”</a>) and how unimportant variables can be identified (<a href="https://michael-fuchs.netlify.com/2018/12/25/machine-learning-regression-regularization/">“Machine Learning - Regression Regularization”</a>).</p>
<p>In this publication, the prediction of the dependent variables from two different data networks should be central. In particular, the potential for improvement of the predictive power of the created models shall be considered.</p>
<p>For this post the dataset <em>machine</em> from the UCI- Machine Learning Repository platform <a href="https://archive.ics.uci.edu/ml/datasets.html">“UCI”</a> was used as well as the dataset <em>cars</em> from the caret-package. A copy of the records is available at <a href="https://drive.google.com/open?id=1tMtpU5xEkijF-GceVEmGwRQCVrhWNrvf" class="uri">https://drive.google.com/open?id=1tMtpU5xEkijF-GceVEmGwRQCVrhWNrvf</a> (machine) and <a href="https://drive.google.com/open?id=1E_NWwWEBBby456SuHt3qxHrsDpTzcUuv" class="uri">https://drive.google.com/open?id=1E_NWwWEBBby456SuHt3qxHrsDpTzcUuv</a> (cars).</p>
</div>
<div id="presentation-of-the-data-records-used" class="section level1">
<h1>2 Presentation of the data records used</h1>
<p>The first dataframe (machine) contains the characteristics of different CPU models, such as the cycle time and the amount cache memory. PRP will be the dependent variable.The variables that are superfluous for this study are excluded in advance.</p>
<pre class="r"><code>machine &lt;- machine[, 4:10]
head(machine, n = 5)</code></pre>
<pre><code>## # A tibble: 5 x 7
##    MYCT  MMIN  MMAX  CACH CHMIN CHMAX   PRP
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1   125   256  6000   256    16   128   198
## 2    29  8000 32000    32     8    32   269
## 3    29  8000 32000    32     8    32   220
## 4    29  8000 32000    32     8    32   172
## 5    29  8000 16000    32     8    16   132</code></pre>
<p>The second datafame (cars) contains details about different used car components, such as the number of cylinders or the number of miles the car has been driven.</p>
<pre class="r"><code>cars &lt;- cars[, -1]
glimpse(cars)</code></pre>
<pre><code>## Observations: 804
## Variables: 18
## $ Price       &lt;dbl&gt; 22661.05, 21725.01, 29142.71, 30731.94, 33358.77, ...
## $ Mileage     &lt;int&gt; 20105, 13457, 31655, 22479, 17590, 23635, 17381, 2...
## $ Cylinder    &lt;int&gt; 6, 6, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,...
## $ Doors       &lt;int&gt; 4, 2, 2, 2, 2, 2, 2, 2, 2, 4, 4, 4, 4, 4, 4, 4, 4,...
## $ Cruise      &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,...
## $ Sound       &lt;int&gt; 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1,...
## $ Leather     &lt;int&gt; 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1,...
## $ Buick       &lt;int&gt; 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...
## $ Cadillac    &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...
## $ Chevy       &lt;int&gt; 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...
## $ Pontiac     &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...
## $ Saab        &lt;int&gt; 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,...
## $ Saturn      &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...
## $ convertible &lt;int&gt; 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0,...
## $ coupe       &lt;int&gt; 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...
## $ hatchback   &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...
## $ sedan       &lt;int&gt; 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1,...
## $ wagon       &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...</code></pre>
</div>
<div id="dividing-the-data-into-a-training-part-and-a-test-part" class="section level1">
<h1>3 Dividing the data into a training part and a test part</h1>
<pre class="r"><code>set.seed(4352345)
machine_sampling_vector &lt;- createDataPartition(machine$PRP, p = 0.85, list = FALSE)
machine_train &lt;- machine[machine_sampling_vector,]
machine_train_labels &lt;- machine$PRP[machine_sampling_vector]
machine_test &lt;- machine[-machine_sampling_vector,]
machine_test_labels &lt;- machine$PRP[-machine_sampling_vector]
machine_train_features &lt;- machine[, 1:6]</code></pre>
<pre class="r"><code>set.seed(232455)
cars_sampling_vector &lt;- createDataPartition(cars$Price, p = 0.85, list = FALSE)
cars_train &lt;- cars[cars_sampling_vector,]
cars_train_labels &lt;- cars$Price[cars_sampling_vector]
cars_test &lt;- cars[-cars_sampling_vector,]
cars_test_labels &lt;- cars$Price[-cars_sampling_vector]
cars_train_features &lt;- cars[,-1]</code></pre>
</div>
<div id="removing-problematic-features" class="section level1">
<h1>4 Removing problematic features</h1>
<p>Highly correlated variables can influence the prediction of a linear model. From this point of view, it is recommended to overcome this in the first step and to exclude problematic features.</p>
</div>
<div id="machine-dataset" class="section level1">
<h1>4.1 Machine dataset</h1>
<pre class="r"><code>machine_correlations &lt;- cor(machine_train_features)
findCorrelation(machine_correlations)</code></pre>
<pre><code>## integer(0)</code></pre>
<p>As we can see, there is no correlation above 0.9 (by default). Let’s check correlations of 0.75 by this.</p>
<pre class="r"><code>findCorrelation(machine_correlations, cutoff = 0.75)</code></pre>
<pre><code>## [1] 3</code></pre>
<pre class="r"><code>cor(machine_train$MMIN, machine_train$MMAX)</code></pre>
<pre><code>## [1] 0.7679307</code></pre>
<p>Ok we have three of them but 0.75 should not be problematic.</p>
<pre class="r"><code>findLinearCombos(machine_correlations)</code></pre>
<pre><code>## $linearCombos
## list()
## 
## $remove
## NULL</code></pre>
</div>
<div id="cars-dataset" class="section level1">
<h1>4.2 Cars dataset</h1>
<p>Let’s have a look at the cars dataset.</p>
<pre class="r"><code>cars_cor &lt;- cor(cars_train_features)
findCorrelation(cars_cor)</code></pre>
<pre><code>## integer(0)</code></pre>
<pre class="r"><code>findCorrelation(cars_cor, cutoff = 0.75)</code></pre>
<pre><code>## [1] 3</code></pre>
<p>Again three correlations between 0.75 and 0.9 (by default). One example of these three are the correlation betwenn the variables <em>Doors</em> and <em>Coupe</em>.</p>
<pre class="r"><code>cor(cars$Doors,cars$coupe)</code></pre>
<pre><code>## [1] -0.8254435</code></pre>
<pre class="r"><code>table(cars$coupe,cars$Doors)</code></pre>
<pre><code>##    
##       2   4
##   0  50 614
##   1 140   0</code></pre>
<p>Another usefull function is the <em>findLinearCombos</em> function to detect exact linear combinations of other features.</p>
<pre class="r"><code>findLinearCombos(cars)</code></pre>
<pre><code>## $linearCombos
## $linearCombos[[1]]
## [1] 15  4  8  9 10 11 12 13 14
## 
## $linearCombos[[2]]
##  [1] 18  4  8  9 10 11 12 13 16 17
## 
## 
## $remove
## [1] 15 18</code></pre>
<p>Here we are advised to drop the <em>coupe</em> and <em>wagon</em> columns, which are the 15th and 18th features, respectively, because they are exact linear combinations of other features. Note that the division into a training part and a test part must be redone.</p>
<pre class="r"><code>cars &lt;- cars[,c(-15, -18)]
cars_sampling_vector &lt;- createDataPartition(cars$Price, p = 0.85, list = FALSE)
cars_train &lt;- cars[cars_sampling_vector,]
cars_train_labels &lt;- cars$Price[cars_sampling_vector]
cars_test &lt;- cars[-cars_sampling_vector,]
cars_test_labels &lt;- cars$Price[-cars_sampling_vector]
cars_train_features &lt;- cars[,-1]</code></pre>
</div>
<div id="assessing-linear-regression-models" class="section level1">
<h1>5 Assessing linear regression models</h1>
<p>Once all the problematic features have been identified and excluded, it is time to create the regression models.</p>
<pre class="r"><code>machine_model1 &lt;- lm(PRP ~ ., data = machine_train)
cars_model1 &lt;- lm(Price ~ ., data = cars_train)</code></pre>
<p>Here the summary for the machine_model1:</p>
<pre class="r"><code>summary(machine_model1)</code></pre>
<pre><code>## 
## Call:
## lm(formula = PRP ~ ., data = machine_train)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -199.29  -24.15    6.91   26.26  377.47 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -5.963e+01  8.861e+00  -6.730 2.43e-10 ***
## MYCT         5.210e-02  1.885e-02   2.764 0.006335 ** 
## MMIN         1.543e-02  2.025e-03   7.621 1.62e-12 ***
## MMAX         5.852e-03  6.867e-04   8.522 7.68e-15 ***
## CACH         5.311e-01  1.494e-01   3.555 0.000488 ***
## CHMIN        7.761e-02  1.055e+00   0.074 0.941450    
## CHMAX        1.498e+00  2.304e-01   6.504 8.20e-10 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 61.31 on 172 degrees of freedom
## Multiple R-squared:  0.874,  Adjusted R-squared:  0.8696 
## F-statistic: 198.8 on 6 and 172 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>And here the summary for the cars_model1:</p>
<pre class="r"><code>summary(cars_model1)</code></pre>
<pre><code>## 
## Call:
## lm(formula = Price ~ ., data = cars_train)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -9720.6 -1570.0    87.4  1507.1 12974.9 
## 
## Coefficients: (1 not defined because of singularities)
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -1.422e+03  1.096e+03  -1.297  0.19501    
## Mileage     -1.931e-01  1.374e-02 -14.050  &lt; 2e-16 ***
## Cylinder     3.685e+03  1.253e+02  29.416  &lt; 2e-16 ***
## Doors        1.678e+03  2.838e+02   5.912 5.38e-09 ***
## Cruise       3.965e+02  3.311e+02   1.197  0.23160    
## Sound        5.661e+02  2.602e+02   2.176  0.02994 *  
## Leather      8.348e+02  2.768e+02   3.017  0.00265 ** 
## Buick        8.753e+02  6.242e+02   1.402  0.16133    
## Cadillac     1.345e+04  7.040e+02  19.102  &lt; 2e-16 ***
## Chevy       -5.769e+02  4.987e+02  -1.157  0.24775    
## Pontiac     -1.506e+03  5.496e+02  -2.740  0.00630 ** 
## Saab         1.214e+04  6.295e+02  19.279  &lt; 2e-16 ***
## Saturn              NA         NA      NA       NA    
## convertible  1.123e+04  5.859e+02  19.174  &lt; 2e-16 ***
## hatchback   -6.475e+03  6.737e+02  -9.611  &lt; 2e-16 ***
## sedan       -4.697e+03  4.902e+02  -9.582  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2968 on 669 degrees of freedom
## Multiple R-squared:  0.9162, Adjusted R-squared:  0.9144 
## F-statistic: 522.4 on 14 and 669 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Please note the following message from the output: “Coefficients: (1 not defined because of singularities)”. This occurs because we still have features whose effect on the output is indiscernible form other features due to underlying dependencies. We can identify this variable using the <em>alias</em> function.</p>
<pre class="r"><code>alias(cars_model1)</code></pre>
<pre><code>## Model :
## Price ~ Mileage + Cylinder + Doors + Cruise + Sound + Leather + 
##     Buick + Cadillac + Chevy + Pontiac + Saab + Saturn + convertible + 
##     hatchback + sedan
## 
## Complete :
##        (Intercept) Mileage Cylinder Doors Cruise Sound Leather Buick
## Saturn  1           0       0        0     0      0     0      -1   
##        Cadillac Chevy Pontiac Saab convertible hatchback sedan
## Saturn -1       -1    -1      -1    0           0         0</code></pre>
<p>Now we know, that we have to remove the <em>Saturn</em> variable.</p>
<pre class="r"><code>cars_model2 &lt;- lm(Price ~. -Saturn, data = cars_train)
summary(cars_model2)</code></pre>
<pre><code>## 
## Call:
## lm(formula = Price ~ . - Saturn, data = cars_train)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -9720.6 -1570.0    87.4  1507.1 12974.9 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -1.422e+03  1.096e+03  -1.297  0.19501    
## Mileage     -1.931e-01  1.374e-02 -14.050  &lt; 2e-16 ***
## Cylinder     3.685e+03  1.253e+02  29.416  &lt; 2e-16 ***
## Doors        1.678e+03  2.838e+02   5.912 5.38e-09 ***
## Cruise       3.965e+02  3.311e+02   1.197  0.23160    
## Sound        5.661e+02  2.602e+02   2.176  0.02994 *  
## Leather      8.348e+02  2.768e+02   3.017  0.00265 ** 
## Buick        8.753e+02  6.242e+02   1.402  0.16133    
## Cadillac     1.345e+04  7.040e+02  19.102  &lt; 2e-16 ***
## Chevy       -5.769e+02  4.987e+02  -1.157  0.24775    
## Pontiac     -1.506e+03  5.496e+02  -2.740  0.00630 ** 
## Saab         1.214e+04  6.295e+02  19.279  &lt; 2e-16 ***
## convertible  1.123e+04  5.859e+02  19.174  &lt; 2e-16 ***
## hatchback   -6.475e+03  6.737e+02  -9.611  &lt; 2e-16 ***
## sedan       -4.697e+03  4.902e+02  -9.582  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2968 on 669 degrees of freedom
## Multiple R-squared:  0.9162, Adjusted R-squared:  0.9144 
## F-statistic: 522.4 on 14 and 669 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Perfect!</p>
</div>
<div id="how-to-check-some-summary-outputs-individually" class="section level1">
<h1>6 How to check some summary outputs individually</h1>
<p>All the information which we receive with the summary command can also be calculated automatically:</p>
</div>
<div id="residual-analysis" class="section level1">
<h1>6.1 Residual analysis</h1>
<p>A residual is simply the error our model makes for a paritcular observation.</p>
<pre class="r"><code>summary(cars_model2$residuals)</code></pre>
<pre><code>##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
## -9720.63 -1570.00    87.39     0.00  1507.05 12974.87</code></pre>
<pre class="r"><code>mean(cars_train$Price)</code></pre>
<pre><code>## [1] 21463.74</code></pre>
<p>With this information we can say that the average selling price of a car in our training data is around 21k Dollar, and 50% of our predictions are roughly within +- 1.6k of the correct value.</p>
<p>A useful way to graphically compare the quantiles of the distributions of two quantitative variables is the quantile-quantile diagram.</p>
<pre class="r"><code>par(mfrow = c(2, 1))
machine_residuals &lt;- machine_model1$residuals
qqnorm(machine_residuals, main = &quot;Normal Q-Q Plot for CPU data set&quot;)
qqline(machine_residuals)
cars_residuals &lt;- cars_model2$residuals
qqnorm(cars_residuals, main = &quot;Normal Q-Q Plot for Cars data set&quot;)
qqline(cars_residuals)</code></pre>
<p><img src="/post/2019-01-11-machine-learning-predictions-with-linear-regressions_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<p>As we can see the residuals from both models seem to lie reasonably close to the theoretical quantiles of a normal distribution, although the fit isn’t perfect, as is typical with most real-world data.</p>
</div>
<div id="significance-tests-for-linear-regression" class="section level1">
<h1>6.2 Significance tests for linear regression</h1>
<p>Let’s have a look at the machine_model1 output again:</p>
<pre class="r"><code>summary(machine_model1)</code></pre>
<pre><code>## 
## Call:
## lm(formula = PRP ~ ., data = machine_train)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -199.29  -24.15    6.91   26.26  377.47 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -5.963e+01  8.861e+00  -6.730 2.43e-10 ***
## MYCT         5.210e-02  1.885e-02   2.764 0.006335 ** 
## MMIN         1.543e-02  2.025e-03   7.621 1.62e-12 ***
## MMAX         5.852e-03  6.867e-04   8.522 7.68e-15 ***
## CACH         5.311e-01  1.494e-01   3.555 0.000488 ***
## CHMIN        7.761e-02  1.055e+00   0.074 0.941450    
## CHMAX        1.498e+00  2.304e-01   6.504 8.20e-10 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 61.31 on 172 degrees of freedom
## Multiple R-squared:  0.874,  Adjusted R-squared:  0.8696 
## F-statistic: 198.8 on 6 and 172 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>We can compute some figures manually, eg. the t-value and p-value of the MYCT variable:</p>
<pre class="r"><code>q &lt;- 5.210e-02 / 1.885e-02
q</code></pre>
<pre><code>## [1] 2.763926</code></pre>
<pre class="r"><code>pt(q, df = 172, lower.tail = F) * 2</code></pre>
<pre><code>## [1] 0.006333496</code></pre>
</div>
<div id="residual-standard-error-rse" class="section level1">
<h1>6.3 Residual Standard Error (RSE)</h1>
<p>We define a metric known as the Residual Standard Error, which estimates the standard deviation of our model compared to the target function.</p>
<p>We can compute the RSE for our two models using the preceding formular as follows:</p>
<pre class="r"><code>n_machine &lt;- nrow(machine_train)
k_machine &lt;- length(machine_model1$coefficients) - 1
sqrt(sum(machine_model1$residuals ^ 2) / (n_machine - k_machine - 1))</code></pre>
<pre><code>## [1] 61.30743</code></pre>
<pre class="r"><code>n_cars &lt;- nrow(cars_train)
k_cars &lt;- length(cars_model2$coefficients) - 1
sqrt(sum(cars_model2$residuals ^ 2) / (n_cars - k_cars - 1))</code></pre>
<pre><code>## [1] 2967.523</code></pre>
<p>To interpret the RSE values for our two models, we neet to compare them with the mean of our output variables.</p>
<pre class="r"><code>mean(machine_train$PRP)</code></pre>
<pre><code>## [1] 109.4804</code></pre>
<pre class="r"><code>mean(cars_train$Price)</code></pre>
<pre><code>## [1] 21463.74</code></pre>
<p>We can compare this:</p>
<ul>
<li>RSE of machine dataset: 61,31 and mean 109,48</li>
<li>RSE of cars dataset: 2.967,52 and mean 21.463,74</li>
</ul>
</div>
<div id="r2" class="section level1">
<h1>6.4 R<sup>2</sup></h1>
<p>Now let’s compute R<sup>2</sup> manually to compare different regression models.</p>
<pre class="r"><code>compute_rsquared &lt;- function(x, y) {
  rss &lt;- sum((x - y) ^ 2)
  tss &lt;- sum((y - mean(y)) ^ 2)
  return(1 - (rss / tss))
}

compute_rsquared(machine_model1$fitted.values, machine_train$PRP)</code></pre>
<pre><code>## [1] 0.8739904</code></pre>
<pre class="r"><code>compute_rsquared(cars_model2$fitted.values, cars_train$Price)</code></pre>
<pre><code>## [1] 0.9161895</code></pre>
</div>
<div id="adjusted-r2" class="section level1">
<h1>6.5 Adjusted R<sup>2</sup></h1>
<p>We can also do the same manual calculation for the adjusted R<sup>2</sup>.</p>
<pre class="r"><code>compute_adjusted_rsquared &lt;- function(x, y, k) {
  n &lt;- length(y)
  r2 &lt;- compute_rsquared(x, y)
  return(1 - ((1 - r2) * (n - 1) / (n - k - 1)))
}

compute_adjusted_rsquared(machine_model1$fitted.values, machine_train$PRP, k_machine)</code></pre>
<pre><code>## [1] 0.8695947</code></pre>
<pre class="r"><code>compute_adjusted_rsquared(cars_model2$fitted.values, cars_train$Price, k_cars)</code></pre>
<pre><code>## [1] 0.9144357</code></pre>
</div>
<div id="test-set-performance-with-the-mse" class="section level1">
<h1>7 Test set performance with the MSE</h1>
<p>Now it’s time to check the test set performance of our models. We can do this by the Mean Squared Error (<strong>MSE</strong>).</p>
<pre class="r"><code>machine_model1_predictions &lt;- predict(machine_model1, machine_test)
cars_model2_predictions &lt;- predict(cars_model2, cars_test)</code></pre>
<p>Here is the required function for it:</p>
<pre class="r"><code>compute_mse &lt;- function(predictions, actual) { 
  mean( (predictions - actual) ^ 2 ) 
}</code></pre>
</div>
<div id="mse-for-the-machine-dataset" class="section level1">
<h1>7.1 MSE for the machine dataset</h1>
<p>Now we can compare the training and the test MSE for both models</p>
<pre class="r"><code>compute_mse(machine_model1$fitted.values, machine_train$PRP)</code></pre>
<pre><code>## [1] 3611.616</code></pre>
<pre class="r"><code>compute_mse(machine_model1_predictions, machine_test$PRP)</code></pre>
<pre><code>## [1] 2814.048</code></pre>
</div>
<div id="mse-for-the-cars-dataset" class="section level1">
<h1>7.2 MSE for the cars dataset</h1>
<pre class="r"><code>compute_mse(cars_model2$fitted.values, cars_train$Price)</code></pre>
<pre><code>## [1] 8613075</code></pre>
<pre class="r"><code>compute_mse(cars_model2_predictions, cars_test$Price)</code></pre>
<pre><code>## [1] 6572315</code></pre>
</div>
<div id="problems-with-linear-regression" class="section level1">
<h1>8 Problems with linear regression</h1>
<p>In my post <a href="https://michael-fuchs.netlify.com/2018/09/21/regression-analysis/">“Regression Analysis”</a> paragraph 5 Model assumption I have already addressed several aspects that must be taken into account when creating a regression model. For the present investigation of the two datasets two aspects are dealt with in detail.</p>
</div>
<div id="multicollinearity" class="section level1">
<h1>8.1 Multicollinearity</h1>
<p>Multicollinearity is a problem of regression analysis and occurs when two or more explanatory variables have a very strong correlation with each other. We can check this with the <em>vif</em> function.</p>
<pre class="r"><code>vif(cars_model2)</code></pre>
<pre><code>##     Mileage    Cylinder       Doors      Cruise       Sound     Leather 
##    1.008691    2.405865    4.618441    1.584216    1.130795    1.189614 
##       Buick    Cadillac       Chevy     Pontiac        Saab convertible 
##    2.638722    3.446297    4.654469    3.612065    3.713443    1.672783 
##   hatchback       sedan 
##    2.388387    4.476334</code></pre>
<p>These values can also be calculated manually by us. Here is the example for the calculation of the value for the variable Sedan</p>
<pre class="r"><code>sedan_model &lt;- lm(sedan ~ .-Price -Saturn, data = cars_train)
sedan_r2 &lt;- compute_rsquared(sedan_model$fitted.values, cars_train$sedan)
1 / (1-sedan_r2)</code></pre>
<pre><code>## [1] 4.476334</code></pre>
</div>
<div id="outliers" class="section level1">
<h1>8.2 Outliers</h1>
<p>Outliers should always be taken into account in predictive models, as they can greatly influence the forecast, as the following example shows:</p>
<pre class="r"><code>scatterplot(machine_model1$fitted.values, machine_model1$residuals, id = TRUE, xlab = &quot;Fitted Values&quot;, ylab = &quot;Residuals&quot;, main = &quot;Searching for outliers&quot;)</code></pre>
<p><img src="/post/2019-01-11-machine-learning-predictions-with-linear-regressions_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
<pre><code>## [1]   9 171</code></pre>
<p>As we can see in the graphic line 172 is an outlier. Now we check what effect it has when we exclude line 172 from the training part.</p>
<pre class="r"><code>machine_model2 &lt;- lm(PRP ~ ., data = machine_train[!(rownames(machine_train)) %in% c(171),])

summary(machine_model2)</code></pre>
<pre><code>## 
## Call:
## lm(formula = PRP ~ ., data = machine_train[!(rownames(machine_train)) %in% 
##     c(171), ])
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -156.096  -20.058    4.808   20.405  297.999 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -45.121358   7.614012  -5.926 1.67e-08 ***
## MYCT          0.040621   0.015852   2.562 0.011256 *  
## MMIN          0.016930   0.001705   9.927  &lt; 2e-16 ***
## MMAX          0.004654   0.000592   7.862 4.07e-13 ***
## CACH          0.493464   0.125242   3.940 0.000118 ***
## CHMIN         1.561303   0.900744   1.733 0.084836 .  
## CHMAX         0.917632   0.204514   4.487 1.32e-05 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 51.37 on 171 degrees of freedom
## Multiple R-squared:  0.8884, Adjusted R-squared:  0.8844 
## F-statistic: 226.8 on 6 and 171 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div id="compare-rse" class="section level1">
<h1>8.2.1 Compare RSE</h1>
<pre class="r"><code>sqrt(sum(machine_model1$residuals ^ 2) / (n_machine - k_machine - 1))</code></pre>
<pre><code>## [1] 61.30743</code></pre>
<pre class="r"><code>k_machine &lt;- length(machine_model2$coefficients) - 1
sqrt(sum(machine_model2$residuals ^ 2) / (n_machine - k_machine - 1))</code></pre>
<pre><code>## [1] 51.22046</code></pre>
<p>Here we cas see the imporvement of RSE:</p>
<ul>
<li>machine_model1: 61,31</li>
<li>machine_model2: 51,22</li>
</ul>
</div>
<div id="compare-mse" class="section level1">
<h1>8.2.2 Compare MSE</h1>
<pre class="r"><code>compute_mse(machine_model1_predictions, machine_test$PRP)</code></pre>
<pre><code>## [1] 2814.048</code></pre>
<pre class="r"><code>machine_model2_predictions &lt;- predict(machine_model2, machine_test)
compute_mse(machine_model2_predictions, machine_test$PRP)</code></pre>
<pre><code>## [1] 2555.355</code></pre>
<p>Here we cas see the imporvement of MSE:</p>
<ul>
<li>machine_model1: 2.814,05</li>
<li>machine_model2: 2.555,36</li>
</ul>
</div>
<div id="future-selection" class="section level1">
<h1>9 Future selection</h1>
<p>Future selection is a machine learning approach, that uses only a subset of the available features for a learning algorithm. To do this we need the null-modell of both regression models.</p>
<pre class="r"><code>machine_model_null &lt;- lm(PRP ~ 1, data = machine_train[!(rownames(machine_train)) %in% c(171),])
cars_model_null &lt;- lm(Price ~ 1, data = cars_train)</code></pre>
<p>There are two types of future selection to operate: the forward selection and the backward selection (both demonstrated below). Note that the lower the AIC, the better the model.</p>
</div>
<div id="forward-selection" class="section level1">
<h1>9.1 Forward selection</h1>
<pre class="r"><code>machine_model3 &lt;- step(machine_model_null, scope = list(lower = machine_model_null, upper = machine_model2), direction = &quot;forward&quot;)</code></pre>
<pre><code>## Start:  AIC=1787.41
## PRP ~ 1
## 
##         Df Sum of Sq     RSS    AIC
## + MMIN   1   3024186 1017450 1543.9
## + MMAX   1   3014576 1027059 1545.6
## + CHMIN  1   1905286 2136349 1675.9
## + CACH   1   1715122 2326513 1691.1
## + CHMAX  1   1027234 3014401 1737.2
## + MYCT   1    419045 3622590 1769.9
## &lt;none&gt;               4041635 1787.4
## 
## Step:  AIC=1543.88
## PRP ~ MMIN
## 
##         Df Sum of Sq     RSS    AIC
## + MMAX   1    363637  653813 1467.2
## + CHMAX  1    335100  682350 1474.8
## + CACH   1    182079  835371 1510.8
## + CHMIN  1    169482  847968 1513.5
## &lt;none&gt;               1017450 1543.9
## + MYCT   1      5017 1012433 1545.0
## 
## Step:  AIC=1467.17
## PRP ~ MMIN + MMAX
## 
##         Df Sum of Sq    RSS    AIC
## + CHMAX  1    131337 522477 1429.2
## + CACH   1    106712 547102 1437.5
## + CHMIN  1     73565 580248 1447.9
## &lt;none&gt;               653813 1467.2
## + MYCT   1      3554 650259 1468.2
## 
## Step:  AIC=1429.25
## PRP ~ MMIN + MMAX + CHMAX
## 
##         Df Sum of Sq    RSS    AIC
## + CACH   1     47136 475340 1414.4
## + CHMIN  1     17352 505124 1425.2
## + MYCT   1     10664 511813 1427.6
## &lt;none&gt;               522477 1429.2
## 
## Step:  AIC=1414.42
## PRP ~ MMIN + MMAX + CHMAX + CACH
## 
##         Df Sum of Sq    RSS    AIC
## + MYCT   1     16164 459177 1410.3
## + CHMIN  1      6765 468575 1413.9
## &lt;none&gt;               475340 1414.4
## 
## Step:  AIC=1410.26
## PRP ~ MMIN + MMAX + CHMAX + CACH + MYCT
## 
##         Df Sum of Sq    RSS    AIC
## + CHMIN  1    7928.5 451248 1409.2
## &lt;none&gt;               459177 1410.3
## 
## Step:  AIC=1409.16
## PRP ~ MMIN + MMAX + CHMAX + CACH + MYCT + CHMIN</code></pre>
</div>
<div id="backward-selection" class="section level1">
<h1>9.2 Backward selection</h1>
<pre class="r"><code>cars_model3 &lt;- step(cars_model2, scope = list(lower=cars_model_null, upper=cars_model2), direction = &quot;backward&quot;)</code></pre>
<pre><code>## Start:  AIC=10952.65
## Price ~ (Mileage + Cylinder + Doors + Cruise + Sound + Leather + 
##     Buick + Cadillac + Chevy + Pontiac + Saab + Saturn + convertible + 
##     hatchback + sedan) - Saturn
## 
##               Df  Sum of Sq        RSS   AIC
## - Chevy        1   11785080 5.9031e+09 10952
## - Cruise       1   12624563 5.9040e+09 10952
## &lt;none&gt;                      5.8913e+09 10953
## - Buick        1   17313415 5.9087e+09 10953
## - Sound        1   41680541 5.9330e+09 10956
## - Pontiac      1   66129626 5.9575e+09 10958
## - Leather      1   80130600 5.9715e+09 10960
## - Doors        1  307819686 6.1992e+09 10986
## - sedan        1  808547086 6.6999e+09 11039
## - hatchback    1  813515122 6.7049e+09 11039
## - Mileage      1 1738450958 7.6298e+09 11128
## - Cadillac     1 3213404568 9.1047e+09 11248
## - convertible  1 3237410059 9.1288e+09 11250
## - Saab         1 3273141146 9.1645e+09 11253
## - Cylinder     1 7620155371 1.3511e+10 11518
## 
## Step:  AIC=10952.02
## Price ~ Mileage + Cylinder + Doors + Cruise + Sound + Leather + 
##     Buick + Cadillac + Pontiac + Saab + convertible + hatchback + 
##     sedan
## 
##               Df  Sum of Sq        RSS   AIC
## - Cruise       1   10513784 5.9136e+09 10951
## &lt;none&gt;                      5.9031e+09 10952
## - Sound        1   35714096 5.9388e+09 10954
## - Leather      1   72731640 5.9759e+09 10958
## - Pontiac      1   74615696 5.9777e+09 10959
## - Buick        1   78868978 5.9820e+09 10959
## - Doors        1  301432401 6.2046e+09 10984
## - sedan        1  799190933 6.7023e+09 11037
## - hatchback    1  834442317 6.7376e+09 11040
## - Mileage      1 1733583701 7.6367e+09 11126
## - convertible  1 3227592370 9.1307e+09 11248
## - Cadillac     1 6261095922 1.2164e+10 11445
## - Saab         1 6366524355 1.2270e+10 11450
## - Cylinder     1 7658368713 1.3561e+10 11519
## 
## Step:  AIC=10951.24
## Price ~ Mileage + Cylinder + Doors + Sound + Leather + Buick + 
##     Cadillac + Pontiac + Saab + convertible + hatchback + sedan
## 
##               Df  Sum of Sq        RSS   AIC
## &lt;none&gt;                      5.9136e+09 10951
## - Sound        1   36567231 5.9502e+09 10954
## - Leather      1   68644463 5.9823e+09 10957
## - Pontiac      1   71927520 5.9856e+09 10958
## - Buick        1   90676966 6.0043e+09 10960
## - Doors        1  292429487 6.2061e+09 10982
## - sedan        1  789951717 6.7036e+09 11035
## - hatchback    1  851970220 6.7656e+09 11041
## - Mileage      1 1726208830 7.6399e+09 11124
## - convertible  1 3219256417 9.1329e+09 11246
## - Cadillac     1 6279003139 1.2193e+10 11444
## - Saab         1 7931098735 1.3845e+10 11531
## - Cylinder     1 9297956745 1.5212e+10 11596</code></pre>
</div>
<div id="comparing-the-calculated-mse" class="section level1">
<h1>9.3 Comparing the calculated MSE</h1>
<p>Now we can again calculate the MSE for the best models selected by the feature selection:</p>
<pre class="r"><code>machine_model3_predictions &lt;- predict(machine_model3, machine_test)
compute_mse(machine_model3_predictions, machine_test$PRP)</code></pre>
<pre><code>## [1] 2555.355</code></pre>
<pre class="r"><code>cars_model3_predictions &lt;- predict(cars_model3, cars_test)
compute_mse(cars_model3_predictions, cars_test$Price)</code></pre>
<pre><code>## [1] 6572465</code></pre>
<p>Let’s compare the results with the previous models:</p>
<p><strong>Machine dataset:</strong></p>
<ul>
<li>MSE machine_model1_predictions: 2.814,05</li>
<li>MSE machine_model2_predictions: 2.555,36</li>
<li>MSE machine_model3_predictions: 2.555,36</li>
</ul>
<p><strong>Cars dataset:</strong></p>
<ul>
<li>MSE cars_model2_predictions: 6.572.315</li>
<li>MSE cars_model3_predictions: 6.572.465</li>
</ul>
</div>
<div id="regularization" class="section level1">
<h1>10 Regularization</h1>
<p>In addition to the future selection just shown, a regularization can also be used. In the following two methods will be shown on the basis of the car dataset: the ridge method and the lasso method.</p>
<pre class="r"><code>cars_train_mat &lt;- model.matrix(Price ~ .-Saturn, cars_train)[,-1]
lambdas &lt;- 10 ^ seq(8, -4, length = 250)
cars_models_ridge &lt;- glmnet(cars_train_mat, cars_train$Price, alpha = 0, lambda = lambdas)
cars_models_lasso &lt;- glmnet(cars_train_mat, cars_train$Price, alpha = 1, lambda = lambdas)</code></pre>
<p>Here we can see how the Ridge Regression and the Lasso method works:</p>
<pre class="r"><code>layout(matrix(c(1, 2), 1, 2))
plot(cars_models_ridge, xvar = &quot;lambda&quot;, main = &quot;Ridge Regression&quot;)
plot(cars_models_lasso, xvar = &quot;lambda&quot;, main = &quot;Lasso&quot;)</code></pre>
<p><img src="/post/2019-01-11-machine-learning-predictions-with-linear-regressions_files/figure-html/unnamed-chunk-51-1.png" width="672" /></p>
<p>Here is a calculation to determine the best lambda for the two methods:</p>
<pre class="r"><code>ridge.cv &lt;- cv.glmnet(cars_train_mat, cars_train$Price, alpha = 0)
lambda_ridge &lt;- ridge.cv$lambda.min
lambda_ridge</code></pre>
<pre><code>## [1] 739.4489</code></pre>
<pre class="r"><code>lasso.cv &lt;- cv.glmnet(cars_train_mat, cars_train$Price, alpha = 1)
lambda_lasso &lt;- lasso.cv$lambda.min
lambda_lasso</code></pre>
<pre><code>## [1] 12.05117</code></pre>
<p>Again we’ll compare the new MSE:</p>
<pre class="r"><code>cars_test_mat &lt;- model.matrix(Price ~ . -Saturn, cars_test)[,-1]
cars_ridge_predictions &lt;- predict(cars_models_ridge, s = lambda_ridge, newx = cars_test_mat)
compute_mse(cars_ridge_predictions, cars_test$Price)</code></pre>
<pre><code>## [1] 6623786</code></pre>
<pre class="r"><code>cars_lasso_predictions &lt;- predict(cars_models_lasso, s = lambda_lasso, newx = cars_test_mat)
compute_mse(cars_lasso_predictions, cars_test$Price)</code></pre>
<pre><code>## [1] 6491539</code></pre>
<p>The lasso-model performs best. Here again an overview of the different cars model prediction MSEs:</p>
<ul>
<li>MSE cars_model2_predictions: 6.572.315</li>
<li>MSE cars_model3_predictions: 6.572.465</li>
<li>MSE cars_model_lasso_predictions: 6.491.539</li>
</ul>
</div>
<div id="conclusion" class="section level1">
<h1>11 Conclusion</h1>
<p>We have seen how to significantly improve the performance of linear models.</p>
<p>Machine_model2_predictions as well as Machine_model3_predictions with MSE 2.555,36 proved to be the best for the machine data set. We achieved this result with the forward selection.</p>
<p>In contrast to that cars_model_lasso_predictions with MSE 6.491.539 proved to be the best for the cars data set.</p>
</div>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="/js/math-code.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
  </body>
</html>

